<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<title>购物车-花礼网</title>
<meta name="description">
<meta name="keywords">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="renderer" content="webkit|ie-comp">
<link type="text/css" rel="stylesheet" href="/zyl/front/css/cart.css">
</head>
<body class="cart-flow">
	<!-- 顶部导航 -->
	<div class="site-nav">
		<div class="container">
			<ul class="site-nav-l">
				<li class="menu"><a href="#"
					onclick="addfavorite();return false;"><span
						class="ico ico-star"></span>ZYL花城</a></li>
			</ul>
			<ul class="site-nav-r">
				<li class="menu login" id="LoginInfo"><a href="#"
					rel="nofollow" id="btn-login">你好，请登录</a><a href="#" rel="nofollow"
					id="btn-reg">注册</a></li>
				<li class="site-nav-pipe">|</li>
				<li class="menu"><a href="#">订单查询</a></li>
			</ul>
		</div>
	</div>
	<!-- 顶部导航 End -->
	<!-- 头部 -->
	<header> </header>
	<!-- 头部 End -->

	<div class="container" id="cartapp">
		<!-- 订单列表 -->
		<div class="cart-panel">
			<div class="hd">
				<ul class="order-title">
					<li class="selecter"></li>
					<li class="product">商品名称</li>
					<li class="market-price">市场价</li>
					<li class="order-price">订购价</li>
					<li class="num">数量</li>
					<li class="operate">操作</li>
				</ul>
			</div>
			<div class="bd">
				<ul class="order-list" id="cartItem.fid"
					v-for="(cartItem,index) in cartItems">
					<li class="selecter"><i
						v-bind:class="{'icon-select':true,'active':selectFlag[index]}"
						@click="selectFlower(index)"></i>
					<li class="img-box"><a href="javascript:void(0);"
						target="_blank"><img :src="cartItem.flowerImg"></a></li>
					<li class="product"><a href="javascript:void(0);"
						target="_blank"> <span class="product-title"
							style="line-height: 40px;">[{{cartItem.fname}}]&nbsp;{{cartItem.intro}}</span>
							<span class="feature"></span>
					</a></li>
					<li class="market-price"><span class="price-sign">¥</span> <span
						class="price-num"> {{cartItem.price}} </span></li>
					<li class="order-price"><span class="price-sign">¥</span> <span
						class="price-num">{{cartItem.price*cartItem.sale*0.1}} </span></li>
					<li class="num">
						<div class="input-num">
							<a href="javascript:void(0);"
								@click="update(cartItem.fid,index,-1)" class="btn btn-default"><i
								class="ico ico-minus"></i></a> <input type="text"
								class="form-control input-sm" name="cpsl"
								v-bind:value="cartItem.num" min="1" v-bind:max="cartItem.store">
							<a href="javascript:void(0);"
								@click="update(cartItem.fid,index,1)" class="btn btn-default"><i
								class="ico ico-add"></i></a>
						</div>
					</li>
					<li class="order-price"><a href="javascript:void(0);"
						class="delBtn" @click="remove(cartItem.fid,index)">删除</a></li>
				</ul>
			</div>
		</div>
		<div class="set-bar">
			<div class="set-info">
				<a class="back" href="#" style="width: 90px;"><span
					class="ico ico-back"></span>继续挑选</a>
				<div class="set-stat">
					应付金额:
					<div class="price">
						<span class="price-sign">¥</span> <span class="price-num"
							id="totalMoney">148</span>
					</div>
				</div>
			</div>
			<button class="btn btn-primary btn-lg" type="button" @click="order">去结算</button>
		</div>

		<!-- 结算 End -->

	</div>
	<script type="text/javascript" src="/zyl/front/js/cart.js"></script>
	<script type="text/javascript" src="/zyl/back/js/vue.js"></script>
	<script src="/zyl/back/js/axios.js" type="text/javascript"></script>
	<script src="/zyl/front/js/qs.js" type="text/javascript"></script>

	<script type="text/javascript">

let vm = new Vue({
    el: "#cartapp",
    data: {
    	cartItems:'',
    	selectFlag:[]
    	
    },
    methods: {
    	update: function(fid,index,k){
    		console.log(index);
    		console.log(k);
    		let temp=parseInt(this.cartItems[index].num);
			if(k==-1){
				if(temp>1)
					this.cartItems[index].num = temp-1;
			}else{
				if(temp<this.cartItems[index].store)
					this.cartItems[index].num = temp+1;
			}
    		
    		axios.post("/zyl/cart/update",{fid:fid,num:this.cartItems[index].num}).then(res => {
            	console.log(res);
            }); 
    	},
    	remove: function(fid,index){
    		axios.post("/zyl/cart/delete",{fid:fid}).then(res => {
            	console.log(res);
        		this.cartItems.splice(index,1);

            }); 
    	},
    	selectFlower:function(index){
    		vm.$set(vm.selectFlag,index,!this.selectFlag[index]);
    	},
    	order:function(){
    		let carts=[];
    		for(let i=0,len=this.cartItems.length;i<len;i++){
    			if(this.selectFlag[i])
    				carts.push({fid:this.cartItems[i].fid,num:this.cartItems[i].num});
    		}
    		axios.post("/zyl/cart/order",JSON.stringify(carts), {
    			  headers: {
    			    'Content-Type': 'application/json;charset=UTF-8'
    			  }
    			}).then(res =>{
           			console.log(res);
					location.href="orderDetails/"+res.data.data;
    			});
       		
    	}
    },
    mounted: function() { //页面渲染完成后执行的方法
        let arr = window.location.href.split("/");
        this.fid = arr[arr.length - 1]
        axios.get("/zyl/cart/find").then(res => {
        	console.log(res);
        	for(let i=0,len=res.data.data.length;i<len;i++){
                res.data.data[i].flowerImg = res.data.data[i].flowerImg.split(",")[0];
                this.selectFlag.push(true);
        	}
        	this.cartItems = res.data.data;
        });
    },
    created: function() {
      
    }
})

</script>

</body>
</html>